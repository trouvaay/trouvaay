{% extends '_base.html' %}
{% load staticfiles %}
{% load cloudinary %}
{% block beginjs %}
<script type="text/javascript" 
	src=https://maps.googleapis.com/maps/api/js?key=AIzaSyDZTlXL-J2h0DQO0CVDpXbtKOtn_TTCZTU&sensor=true>
</script>
{% endblock %}

{% block modal %}{% endblock %}

{% block content %}
  {% include 'goods/home/_home_slider.html' %}
  {% include 'goods/home/_home_quote.html' %}
  <div class="container">
      <div class="row" style="margin-top: 40px;">
            <div class="col-sm-12 product-description" style="width:100%">
                <div id="map-canvas"> </div>
            </div>
        </div>
  </div>

  <div class="container">
    <div class="grid-products-wrapper">
        <div class="row">
            {% for piece in pieces %}
                {% include 'goods/home/_home_for_loop.html' %}
            {% endfor %}
        </div>
    </div>
  </div>
<div class="container top-bar-border" style="max-width: 100%">
  <div class="row">
  </div>
</div>
  <div class="container">
    <div class="row">
      <div class="col-xs-12 col-sm-4 col-m-4" style="margin-bottom: 2rem">
        {% with sold_pieces as piece %}{% include 'goods/home/_home_sold.html' %}{% endwith %}
      </div>
      <div class="col-xs-12 col-sm-8 col-m-8" style="margin-bottom: 2rem">
      {% with featured_pieces as piece %}
        <div class="grid-products-wrapper">
          <div class="row">
            <div class="col-xs-8">
              {% include 'goods/home/_home_featured.html' %}
            </div>
            <div class="col-xs-4 vcenter">
              <div>{{ piece.description }}</div>
            </div>
          </div>
        {% endwith %}
        </div>
    </div>
  </div>
{% endblock %}
{% block endjs %}
<script type="text/javascript"> 
	function  getpoints (userloc) {
    var products = {{ products_json|safe }};
    var userloc = {
     // 'lat': userloc.coords.latitude,
     // 'lng': userloc.coords.longitude,
     'lat': 37.798530,
    'lng': -122.417966,
    };
      
      var userpos = new google.maps.LatLng(userloc.lat, userloc.lng);
      initializemap(products, userloc);
      for (i in products) {
        add_dists(userpos,products[i],i);
      } 
    };

  function initializemap (products, userpos) {        
    var mapOptions = {
      center: userpos,
      zoom: 12
    };
    var map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions); 
    var UserPin = new google.maps.Marker({
        position: userpos,
        map: map,
        title: 'You'
      });
    for (i in products) {
      var productpos = new google.maps.LatLng(products[i].fields.lat, products[i].fields.lng);
      var pinCounter = parseInt(i)+1;
      var homeMarker = new google.maps.Marker({
            position: productpos,
            map: map,
            icon: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld='+pinCounter+'|FF0000|000000',
            title: products[i].fields.short_name
      });
     };
  };

  function add_dists(userpos, prod, prodnum) {
    var productpos = new google.maps.LatLng(prod.fields.lat, prod.fields.lng);
    var request = {
          origin: userpos,
          destination: productpos,
          travelMode: google.maps.TravelMode.DRIVING
      };
    var directionsService = new google.maps.DirectionsService();
    directionsService.route(request, function(result, status) {
          if (status == google.maps.DirectionsStatus.OK) {
          }
          $(".dist").eq(prodnum).append('</br>('+result.routes[0].legs[0].distance.text+')');
        });
  };
	navigator.geolocation.getCurrentPosition(getpoints);
</script>
{% endblock %}