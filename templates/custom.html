{% load staticfiles %}
<script src="https://checkout.stripe.com/checkout.js"></script>
<script>
var trouvaay = {
	init: function() {

		var mobilemenutop = "<div id='mobile-nav' class='navbar-collapse'>" +
					"<ul class='nav navbar-nav'>" +
                        "<li><a href='{% url 'goods:main' %}'>Shop</a></li>" +
                        "<li class='nav-divider'></li>" +
						"<li><a href='{% url 'goods:about' %}'>About</a></li>" +
                        "<li class='nav-divider'></li>" +
                        "<li>{% if user.is_authenticated %}" +
							"<a href='{% url 'members:logout' %}'>Logout</a>" +
							"{% else %}" +
							"<a href='{% url 'members:login' %}'>Login</a>" +
							"{% endif %}" +
						"</li>" +
						
						"<li class='nav-divider'></li>" +
						"<li><a style='display:inline-block' class='insta-icon mobile' href='http://instagram.com/raredoor/' target='_blank'>" +
								"<img src='{% static 'img/socialicons/instagram.svg' %}'/></a>" +
							"<a style='display:inline-block' class='insta-icon mobile' href='https://www.facebook.com/RareDoor' target='_blank'>" +
								"<img src='{% static 'img/socialicons/facebook.svg' %}'/></a>" +
							"<a style='display:inline-block'class='insta-icon mobile' href='https://twitter.com/RareDoor/' target='_blank'>" +
					 			"<img src='{% static 'img/socialicons/twitter.svg' %}'/></a>" +
					 	"</li>" +
					 "</ul></div>";
        var mobileTabIcons = "<div id='tab-icons-mobile' class='container select-bar hp-tabs' style='border-top: rgb(218, 182, 97) 1px solid;'>"+
                                "<div class='tab-icons mobile'>"+
                                "<div class='row-fluid'>"+
                                    "<div class='col-sm-11 col-md-10'>"+
                                    "<ul class='nav nav-tabs pull-left'>"+
                                        "<li id='everything'><a href='{% url 'goods:landing' %}'>"+
                                        "<span class='inner' style='display:list-item'>"+
                                            "</span><span class='inner icon-label' style='display:list-item'>everything</span>"+
                                            "</a></li>"+
                                        "<li id='seating'><a href='{% url 'goods:main' %}?type=seating'>"+
                                            "<span class='inner' style='display:list-item'>"+
                                            "</span>"+
                                            "<span class='inner icon-label' style='display:list-item'>seating</span>"+
                                            "</a></li>"+
                                        "<li id='tables'><a href='{% url 'goods:main' %}?type=tables'><span class='inner' style='display:list-item'>"+
                                            "</span><span class='inner icon-label' style='display:list-item'>tables</span>"+
                                            "</a></li>"+
                                        "<li id='beds'><a href='{% url 'goods:main' %}?type=beds'><span class='inner' style='display:list-item'></span>"+
                                            "<span class='inner icon-label' style='display:list-item'>beds</span>"+
                                            "</a></li>"+
                                        "<li id='storage'><a href='{% url 'goods:main' %}?type=storage'><span class='inner' style='display:list-item'>"+
                                            "</span><span class='inner icon-label' style='display:list-item'>storage</span>"+
                                            "</a></li>"+
                                        "<li id='lighting'><a href='{% url 'goods:main' %}?type=lighting'><span class='inner' style='display:list-item'>"+
                                            "</span><span class='inner icon-label' style='display:list-item'>lighting</span>"+
                                            "</a></li>"+
                                    "</ul>"+
                                    "</div>"+
                                "</div>"+
                            "</div>"+
                            "</div>";


        //Append mobile menu
		$("#mobile-search").on('click',function() {
                if (!$('#tab-icons-mobile').length ) {
                    console.log('is this workgin?');
                  $("#mobile-navigation").append(mobileTabIcons);
                } else {
                  $("#tab-icons-mobile").remove();
                }
        });

        //Append mobile tab icons
        $("#mob-nav").on('click',function() {
                if (!$('#mobile-nav').length ) {
                  $("#mobile-navigation").append(mobilemenutop);
                } else {
                  $("#mobile-nav").remove();
                }
        });

       $("#filter").on('click',function() {
            if (!$('#desktopSearch').length ) {
              $(".select-bar.hp-").append(desktopsearch);
            } else {
              $("#mobile-nav").remove();
            }
        });

        //Highlights link of current page
        $(function(){
		  $('a').each(function() {
		    if ($(this).prop('href') == window.location.href) {
		      $(this).addClass('current');
		    }
		  });
		});


		//product-like AJAX post
        $(".btn.btn-default.glyphs").click(function() {
            var id = $(this).attr("id").substring(6);
            var data = {'id': id};
            if ($(this).hasClass("active")) {
                $(this).removeClass("active");
                }
            else {
                $(this).addClass("active");
                }
            $.post(
                "{% url 'members:like' %}", 
                data,
                function(response){
                    if(response == 'loginrequired'){
                        window.location.replace("{% url 'members:login' %}");
                    }
                }
            );
        });
        
	}
}

function handleBuyButtonClick(e) {
	console.log('clicked on buy button: '+e.target.id);

	if(e.target.id.substr(0, 4) == 'buy_'){
		var productId = e.target.id.substr(e.target.id.lastIndexOf("_") + 1);
        var orderType = 'buy';
		mixpanel.track(
            "Clicked Buy Button",
            { "productId": productId }
        );
        
		if(productId && !(typeof productId === 'undefined')){
		    console.log('this is the ordertype!', orderType)
	
			var promoCode = ''
			if($("#input-promo-code")) {
				promoCode = $("#input-promo-code").val()
			}
			
			console.log('promoCode: '+promoCode);
			
			// call pre-checkout
			$.ajax({
				type: "POST",
				url: "{% url "members:pre_checkout" %}",
				dataType: "html",
				data: {
					product_id: productId,
	                order_type: orderType,
	                promo_code: promoCode
				},
				success: function(response, status){
					// console.log('response from pre-checkout call: '+status );
					$("#pre-checkout-modal-container").html(response);
					$("#pre-checkout-modal").modal({
						show: true,
						keyboard: true
					});
				},
	            error: function(response, status, error) {
	              var err = eval("(" + response.responseText + ")");
	              alert(err.Message);
	            }
			});
		}        
    }
    else if(e.target.id.substr(0, 8) == 'reserve_'){
        var productId = e.target.id.substr(e.target.id.lastIndexOf("_") + 1);
        var orderType = 'reserve';
        mixpanel.track(
            "Clicked Reserve Button",
            { "productId": productId }
        );
        urlToLoad = "/reserve/"+productId;
        
		if(productId && !(typeof productId === 'undefined')){
		    console.log('ordertype: ', orderType)
			$.ajax({
				type: "GET",
				url: "/reserve/"+productId,
				dataType: "html",
				success: function(response, status){
					// console.log('response from pre-checkout call: '+status );
					$("#pre-checkout-modal-container").html(response);
					$("#researvation-modal").modal({
						show: true,
						keyboard: true
					});
				},
			});
		}        
    }
    
	e.preventDefault();
}

$(document).ready(function() {
    trouvaay.init();
    
    $('[data-toggle="tooltip"]').tooltip({
        'placement': 'bottom'
    });

    //Get furniture type param
    function getParameterByName(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
            results = regex.exec(location.search);
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    };

    function addactivelink (type){
      $('li').each(function() {
        if ($(this).attr('id') == getParameterByName(type)) {
          $(this).addClass('active');
        }
      });
    };

    addactivelink('type');
    //Django boilerplat to Auto add csrf token to template for $.POST Ajax
    function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

		function getCsrfToken(){
			var token = $("#csrftoken-container").children("[name='csrfmiddlewaretoken']").val();
			return token;
		}

        var csrftoken = getCsrfToken() // getCookie('csrftoken');
        
        // console.log('csrftoken: '+csrftoken);
        
        function csrfSafeMethod(method) {
    	// these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    // Send the token to same-origin, relative URLs only.
                    // Send the token only if the method warrants CSRF protection
                    // Using the CSRFToken value acquired earlier
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
	
	$('.view-product').on('click', function(e) {
        var productslug = e.target.pathname.substr(7);
        mixpanel.track(
                "Clicked Detail Page",
                { "productSlug": productslug }
            );
        console.log('clicked detail page-post');
    })

	// navigation login
	$('.nav-login-button').on('click', function(e) {
		$.ajax({
			type: "GET",
			dataType: "html",
			url: "{% url "members:ajax_login" %}",
			success: function(response, status){
				console.log('status ['+status+']');
				if(status == 'success'){
					console.log('loaded ajax_login');
					$("#ajax-login-modal-container").html(response);
					var currentUrl = document.URL;
					
					// after login redirect where we were except 'login' itself
					// so that we don't end up with a loop
					
					console.log(currentUrl.indexOf("{% url 'members:login' %}"));
					
					if(currentUrl.indexOf("{% url 'members:login' %}") === -1){
						$("#id_next").val(currentUrl);
						console.log($("#id_next").val());
					}
					$("#signup-login-modal").modal({
						show: true,
						keyboard: true
					});
				}			
			}
		});
	});

	// Stripe checkout
	$('.btn.buy').on('click', handleBuyButtonClick);

});
//Unsed formula to append distance from product to user's loco
//  function  getpoints (userloc) {
//      var products = {{ products_json|safe }};
//      var userloc = {
//       'lat': userloc.coords.latitude,
//       'lng': userloc.coords.longitude,
//      };
          
//          var userpos = new google.maps.LatLng(userloc.lat, userloc.lng);
//          for (i in products) {
//              console.log(products[i]);
//          add_dists(userpos,products[i],i);
//          } 
//     };

//  function add_dists(userpos, prod, prodnum) {
//      var productpos = new google.maps.LatLng(prod.fields.lat, prod.fields.lng);
//      var request = {
//            origin: userpos,
//            destination: productpos,
//            travelMode: google.maps.TravelMode.DRIVING
//        };
//      var directionsService = new google.maps.DirectionsService();
//      directionsService.route(request, function(result, status) {
//            if (status == google.maps.DirectionsStatus.OK) {
//              var id = "buy_"+prod.pk;
//              console.log(id);
//              $(id).append(result.routes[0].legs[0].distance.text);
//            } 
//          });
//  };

//  navigator.geolocation.getCurrentPosition(getpoints);

</script>

